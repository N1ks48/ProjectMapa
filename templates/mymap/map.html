{% extends "mymap/main.html" %}

{% block main %}
    <li class="nav-item">
        <a class="nav-link active" aria-current="page" href="/">Головна</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{% url 'changes' %}">Внести зміни</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="#">Link</a>
    </li>
    <li class="nav-item">
        <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">Disabled</a>
    </li>
{% endblock %}
{% block filter %}
    <form method="post" action="{% url 'maps_filter' %}" class="needs-validation" novalidate>
        {% csrf_token %}
        <div class="mb-3 mt-4">
            <label for="aptid" class="form-label">ID Аптеки:</label>
            <input type="text" class="form-control" aria-label="Sizing example input"
                   aria-describedby="inputGroup-sizing-default" id="aptid" name="aptid" autocomplete="off">
        </div>

        <div class="mb-3 mt-4">
            <label for="name" class="form-label">Аптека\Адреса:</label>
            <input type="text" class="form-control" aria-label="Sizing example input"
                   aria-describedby="inputGroup-sizing-default" id="name" name="name" autocomplete="off">
        </div>

        <div class="mb-3 mt-4">
            <label for="city" class="form-label">Місто:</label>
            <input type="text" class="form-control" aria-label="Sizing example input"
                   aria-describedby="inputGroup-sizing-default" id="city" name="city" autocomplete="off">
        </div>

        <div class="form-group md-3 mt-4">
            <label for="okpo">Фірма:</label>
            <div class="input-group">
                <input type="text" id="okpo" name="okpo" list="okpo1" class="form-control"
                       autocomplete="off">
                <div class="input-group-append">
                    <datalist id="okpo1" class="list-styled">
                        {{ html_options|safe }}
                    </datalist>
                </div>
            </div>
        </div>
        <br>
        <button type="submit" class="btn btn-primary">Пошук</button>
    </form>
    <br>
    <button onclick="hideFilter()" class="bg-transparent border-0">
        <img id="mapImage" class="mt-1" width="32" height="32" src="/static/images/zoom-out.svg" alt="Submit">
    </button>

    <button onclick="hideMaps()" class="bg-transparent border-0">
        <img class="mt-1" width="32" height="32" src="/static/images/maps72040.png" alt="Submit">
    </button>

{% endblock %}
{% block button %}
    <button onclick="hideFilter()" class="bg-transparent border-0">
        <img id="mapImage" class="mt-1" width="32" height="32" src="/static/images/zoom-in.svg" alt="Submit">
    </button>
    <br>
    <button onclick="hideMaps()" class="bg-transparent border-0">
        <img class="mt-1" width="32" height="32" src="/static/images/maps72040.png" alt="Submit">
    </button>
{% endblock %}
{% block maps %}
    <!-- Карта, занимает оставшиеся 70% ширины -->
    <div id="map" class="border border rounded bg-light text-dark"
         style="height: 510px; display: block;"></div>
    {% if 'mapsfilter/' in request.path %}
        <div id="table"
             style="max-height: 300px; overflow: auto;">
            <div class="mt-2">
                <table class="table table-hover">
                    <thead class="sticky-top" style="background-color: rgb(236,240,245);">
                    <tr>
                        <th scope="col">Назва</th>
                        <th scope="col">Місто</th>
                        <th scope="col">Фірма</th>
                        <th scope="col">Статус</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for item in locations %}
                        <tr id="row_{{ forloop.counter }}">
                            <td>{{ item.name }}
                                <br>
                                <button type="button" class="badge rounded-pill bg-secondary open-modal"
                                        data-item0="{{ item.name }}"
                                        data-item1="{{ item.city }}"
                                        data-item2="{{ item.okpo }}"
                                        data-item3="{{ item.status }}"
                                        data-bs-toggle="modal"
                                        data-bs-target="#exampleModal"
                                        @click="openModal"
                                        style="font-size: 0.55rem;">
                                    Редагувати
                                </button>
                            </td>
                            <td>{{ item.city }}</td>
                            <td>{{ item.okpo }}</td>
                            <td>{{ item.status }}</td>

                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="9">Немає даних, що задовольняють фільтру</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% endif %}

{% endblock %}
{% block script %}
    <script>
        //Вывод данных на карту
        function downData() {
            alert("Немає даних для вивантаження")
        }

        let map = L.map('map').setView([49.00, 31.00], 6);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        let locations = {{ locations|safe }};


        for (let i = 0; i < locations.length; i++) {
            L.marker([locations[i].latitude, locations[i].longitude]).addTo(map)
                .bindPopup(`<b>${locations[i].name}</b><br>${locations[i].city}<br>${locations[i].okpo}<br>Статус: ${locations[i].status}`);
        }


        //Путешествие по карте, по клику на таблице
        document.addEventListener('DOMContentLoaded', function () {
            // Добавьте обработчик событий для каждой строки таблицы
            {% for item in locations %}
                document.getElementById('row_{{ forloop.counter }}').addEventListener('click', function () {
                    map.setView([{{ item.latitude }}, {{ item.longitude }}], 20); // Центрируйте карту на кликнутых координатах
                });
            {% endfor %}
        });

        $(document).on('click', '.open-modal', function openModal(event) {
            // Получение данных из data-item атрибутов кнопки
            let item0 = $(event.target).data('item0');
            let item1 = $(event.target).data('item1');
            let item2 = $(event.target).data('item2');
            let item3 = $(event.target).data('item3');


            let results = [item0, item1, item2, item3];
            populateModal(results)
            $('#exampleModal').modal('show');
        });

        // Заполнение полей модального окна данными из строк
        function populateModal(results) {
            $('#item_0').val(results[0]);
            $('#item_1').val(results[1]);
            $('#item_2').val(results[2]);
            $('#item_3').val(results[3]);


            let modalNumber = results[0];
            document.getElementById('modalNumber').innerText = 'Аптека: ' + modalNumber;
        }

        //Скрытие карты
        function hideMaps() {
            let mapForm = document.getElementById('map');
            let tableForm = document.getElementById('table');

            if (mapForm.style.display === 'block') {
                mapForm.style.display = 'none';
                tableForm.style.display = 'block';
                tableForm.style.maxHeight = '700px';

            } else {
                mapForm.style.display = 'block';
                tableForm.style.display = 'block';
                tableForm.style.maxHeight = '300px';

            }
        }
    </script>
{% endblock %}


